<!DOCTYPE html>

	<head>
		
		<script src="svg.js"></script>

	</head>

	<body style = "position: fixed; top: 0; left: 0; right: 0; bottom: 0;">
		
		<div id='svg' style="width:100%; height:100%"></div>

		<script>

			// Constructor for System
			function System(commandMap, rules, constants, axiom){

				this.variables = [];
				this.commandMap = {};

				for(var i = 0; i < commandMap.length; i++){
					this.variables[i] = commandMap[i].variable;
					// variable to command array
					this.commandMap[commandMap[i].variable] = commandMap[i].command;
				}

				this.constants = constants;
				this.axiom = axiom;

				this.rules = {

					Init : function(constants){
						for(var i = 0; i < constants.length; i++){
							this[constants[i]] = constants[i];
						}
					}
				};

				for(var i = 0; i < rules.length; i++){
					this.rules[rules[i][0]] = rules[i][1];
				}

				this.Init = function(){
					this.rules.Init(this.constants);
				};

				this.Run = function(iterations){

					var product = this.axiom;

					for(var i = 0; i < iterations; i++){
						product = this.ApplyRules(product);
					}

					return product;
				};

				this.ApplyRules = function(string){

					var result = ""

					for(var i = 0; i < string.length; i++){
						result += this.rules[string[i]];
					}

					return result;
				};
			}

			var turtle = {

				vector : {x:0,y:-1},
				pos : {x:0, y:0},
				lastPos : {x:0, y:0},

				min : {x:0, y:0},
				max:{x:0, y:0},

				svg: null,

				Init : function(){

					this.lastPos.x = this.pos.x;
					this.lastPos.y = this.pos.y;

					this.svg = SVG('svg').size('100%', '100%');
				},

				Reset : function(){

					this.vector = {x:0,y:-1};
					this.pos = {x:0, y:0};
					this.lastPos = {x:0, y:0};
					this.min = {x:0, y:0};
					this.max = {x:0, y:0};

					this.svg.clear();
				},

				commands : {
					"Draw" : function(params){this.Draw(params.distance);},
					"Rotate" : function(params){this.Rotate(params.degrees);}
				},

				Run : function(string, commandMap){

					var command = null;

					for(var i = 0; i < string.length; i++){
						command = commandMap[string[i]];
						// find command type, bind to turtle, pass parameter object
						if(command != null) this.commands[command[0]].bind(this)(command[1]);
					}

					var width = this.max.x - this.min.x;
					var height = this.max.y - this.min.y;
					//this.svg.viewbox(0, this.max.y, this.max.x, -this.max.y);
					//this.svg.viewbox(0, this.max.y, this.max.x, -this.max.y);
					this.svg.viewbox(this.min.x - width * 0.1, this.min.y - height * 0.1, width * 1.2, height * 1.2);
					console.log(JSON.stringify(this.max));
					console.log(this.svg.viewbox().zoom);

					//var rect = this.svg.rect(width, height);
					//rect.move(this.min.x, this.min.y);
				},

				Draw : function(distance){

					this.lastPos.x = this.pos.x;
					this.lastPos.y = this.pos.y;

					this.pos.x += (this.vector.x * distance); 
					this.pos.y += (this.vector.y * distance);

					if(this.pos.x > this.max.x) this.max.x = this.pos.x;
					if(this.pos.x < this.min.x) this.min.x = this.pos.x;
					if(this.pos.y > this.max.y) this.max.y = this.pos.y;
					if(this.pos.y < this.min.y) this.min.y = this.pos.y;

					this.svg.line(this.lastPos.x, this.lastPos.y, this.pos.x, this.pos.y).stroke({width:2});
				},

				Rotate : function(degrees){
					this.vector = Rotate(this.vector, degrees);
				}
			}

			var koch = new System(
				[	
					{variable : "F", command : ["Draw", {distance: 5}]},
					{variable : "+", command : ["Rotate", {degrees: -90}]},
					{variable : "-", command : ["Rotate", {degrees: 90}]}
				],
				[
					["F", "F+F-F-F+F"]
				],
				["+", "-"],
				"F"
			);

			var sierpenski = new System(
				[
					{variable : "A", command : ["Draw", {distance: 5}]},
					{variable : "B", command : ["Draw", {distance: 5}]},
					{variable : "+", command : ["Rotate", {degrees: -60}]},
					{variable : "-", command : ["Rotate", {degrees: 60}]}
				],
				[
					["A", "+B-A-B+"],
					["B", "-A+B+A-"]
				],
				["+", "-"],
				"A"
			);

			var dragonCurve = new System(
				[
					{variable : "F", command : ["Draw", {distance: 5}]},
					{variable : "-", command : ["Rotate", {degrees: -90}]},
					{variable : "+", command : ["Rotate", {degrees: 90}]},
				],
				[
					["X", "X+YF+"],
					["Y", "-FX-Y"]
				],
				["F", "+", "-"],
				"FX"
			);

			var sys = dragonCurve;
			sys.Init();
			turtle.Init();

			var iterations = 3;

			Repaint();

			function Repaint(){

				turtle.Reset();
				var string = sys.Run(iterations);
				turtle.Run(string, sys.commandMap);
			}

			function ApplyRules(string){

				var result = "";

				for(var i = 0; i < string.length; i++){
					result += rules[string[i]];
				}

				return result;
			}

			function Rotate(vector, degrees){

				var result = {x:0,y:0};
				var radian = DegToRad(degrees);

				result.x = vector.x * Math.cos(radian) - vector.y * Math.sin(radian);
				result.y = vector.x * Math.sin(radian) + vector.y * Math.cos(radian);

				return result;
			}

			function DegToRad(degrees){
				return degrees * Math.PI / 180;
			}

			window.addEventListener("keypress", HandleKeyPress, false);

			function HandleKeyPress(e){

				console.log("key press: " + e.charCode);
				console.log(JSON.stringify(e));

				var redraw = false;

				if(e.charCode == "61"){
					iterations++;
					redraw = true;
				}
				if(e.charCode == "45"){
					iterations--;
					redraw = true;
				}

				if(redraw) Repaint();
			}

		</script>

	</body>

</html>